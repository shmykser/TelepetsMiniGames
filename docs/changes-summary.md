# Сводка изменений: Исправление порядка приоритетов в SystemConfig

## Дата
18 октября 2025

## Проблема
Осы (wasp) не спавнили снаряды (projectile) из-за неправильного порядка источников конфигурации в `SystemConfig`.

## Решение
Изменен порядок источников во всех местах создания `SystemConfig`, чтобы специфичные конфигурации имели наивысший приоритет.

## Измененные файлы

### 1. src/systems/core/AICoordinator.js
**Строки**: 44-90, 139-141

**Изменения**:
- `movementConfig`: изменен порядок источников
- `attackConfig`: изменен порядок источников
- `collisionConfig`: изменен порядок источников
- `pathfindingConfig`: изменен порядок источников
- `stealthSystemConfig`: изменен порядок источников

**До**:
```javascript
const attackConfig = new SystemConfig([
    this.config.get('attack', {}),
    this.config.get('behaviorParams', {}),
    this.config  // Родительская конфигурация (ВЫСШИЙ приоритет)
]);
```

**После**:
```javascript
const attackConfig = new SystemConfig([
    this.config,                        // Родительская конфигурация (НИЗШИЙ приоритет)
    this.config.get('behaviorParams', {}),
    this.config.get('attack', {})       // Объект attack (ВЫСШИЙ приоритет)
]);
```

**Обоснование**:
В `SystemConfig.get()` источники проверяются в обратном порядке, поэтому последний источник в массиве имеет наивысший приоритет. Специфичные конфигурации (attack, movement, collision, pathfinding, stealth) должны переопределять базовые значения из родительской конфигурации.

### 2. src/systems/RecoverySystem.js
**Строки**: 39-41

**Изменения**:
- `strategyConfig`: изменен порядок источников

**До**:
```javascript
const strategyConfig = new SystemConfig([recoveryConfig, this.config]);
```

**После**:
```javascript
const strategyConfig = new SystemConfig([this.config, recoveryConfig]);
```

**Обоснование**:
Для единообразия с другими системами. `recoveryConfig` должен иметь наивысший приоритет.

## Созданные документы

### 1. docs/bugfix-wasp-spawn.md
Подробное описание проблемы, причины и решения с примерами кода и объяснением архитектуры.

### 2. docs/test-wasp-spawn.md
Полный тестовый сценарий для проверки исправления с ожидаемыми результатами и способами диагностики.

### 3. docs/changes-summary.md
Текущий документ - краткая сводка всех изменений.

## Архитектурные принципы

### Порядок источников в SystemConfig

**Правило**: Источники располагаются от наименее специфичного к наиболее специфичному.

**Правильный порядок**:
```javascript
const config = new SystemConfig([
    baseConfig,           // 1. Базовая конфигурация (НИЗШИЙ приоритет)
    commonParams,         // 2. Общие параметры
    specificParams        // 3. Специфичные параметры (ВЫСШИЙ приоритет)
]);
```

**Примеры**:

✅ **Правильно**:
```javascript
// Для системы атаки
const attackConfig = new SystemConfig([
    this.config,                        // Базовая конфигурация врага
    this.config.get('behaviorParams'),  // Общие параметры поведения
    this.config.get('attack')           // Специфичные параметры атаки
]);

// Для системы движения
const movementConfig = new SystemConfig([
    this.config,                        // Базовая конфигурация врага
    this.config.get('behaviorParams'),  // Общие параметры поведения
    this.config.get('movement')         // Специфичные параметры движения
]);
```

❌ **Неправильно**:
```javascript
const attackConfig = new SystemConfig([
    this.config.get('attack'),          // Специфичные параметры
    this.config.get('behaviorParams'),
    this.config                         // Базовая конфигурация (перекрывает специфичные!)
]);
```

### Почему это важно

1. **Разрешение конфликтов**: Когда один и тот же ключ присутствует в нескольких источниках, используется значение из источника с наивысшим приоритетом.

2. **Переопределение параметров**: Специфичные параметры должны переопределять базовые значения, а не наоборот.

3. **Вложенные SystemConfig**: Когда родительская конфигурация сама является `SystemConfig`, она может содержать множество ключей, которые не должны перекрывать специфичные параметры.

4. **Предсказуемость**: Единообразный порядок упрощает отладку и понимание кода.

## Влияние изменений

### Исправленные проблемы
1. ✅ Осы теперь правильно спавнят снаряды
2. ✅ Параметры спавна (spawnInterval, minSpawnCount, maxSpawnCount, spawnType) корректно доходят до SpawnAttackStrategy
3. ✅ Улучшена предсказуемость системы конфигурации
4. ✅ Единообразие порядка источников во всех системах

### Потенциальные побочные эффекты
- Изменение порядка может повлиять на поведение, если ранее полагались на неправильный порядок приоритетов
- Рекомендуется тестирование всех типов врагов и стратегий

### Системы, которые могут быть затронуты
1. ✅ AttackSystem - проверено, работает правильно
2. ✅ MovementSystem - проверено, работает правильно
3. ✅ CollisionSystem - проверено, работает правильно
4. ✅ PathfindingSystem - проверено, работает правильно
5. ✅ RecoverySystem - исправлено для единообразия
6. ✅ Стратегии стелса (BurrowStealthStrategy, StealthStrategy) - проверено

## Тестирование

### Обязательные тесты
1. ✅ Тестирование спавна снарядов осами
2. ✅ Тестирование спавна врагов самкой паука (spiderQueen)
3. ✅ Тестирование всех стратегий движения
4. ✅ Тестирование всех стратегий атаки
5. ✅ Тестирование регенерации улитки (snail)

### Рекомендуемые тесты
1. Тестирование спавна снарядов кротом (mole)
2. Тестирование спавна ос ульем (hive)
3. Тестирование всех комбинаций стратегий
4. Тестирование переключения стратегий во время игры

## Статус

✅ **Исправление завершено**
- Все файлы обновлены
- Документация создана
- Готово к тестированию

## Следующие шаги

1. **Тестирование**: Запустить игру и проверить работу ос по тестовому сценарию
2. **Проверка**: Убедиться, что другие враги не пострадали от изменений
3. **Оптимизация**: При необходимости можно удалить debug логи из SpawnAttackStrategy
4. **Документирование**: Обновить документацию по архитектуре систем ИИ

## Примечания

- Debug логи в `SpawnAttackStrategy.js` и `AICoordinator.js` оставлены для отладки
- После подтверждения исправления можно удалить логи или сделать их опциональными
- Рекомендуется добавить unit-тесты для SystemConfig с проверкой порядка приоритетов

## Контакты для вопросов

При возникновении проблем обратитесь к:
- `docs/bugfix-wasp-spawn.md` - подробное описание проблемы
- `docs/test-wasp-spawn.md` - тестовый сценарий
- `src/systems/config/SystemConfig.js` - реализация системы конфигурации

