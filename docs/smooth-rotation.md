# Плавные повороты врагов при обходе препятствий

## Проблема

При обходе препятствий (например, камней) враги мгновенно меняли направление - поворот на 20, 30 или даже 90 градусов происходил за один кадр, что выглядело резко и неестественно.

## Решение

Реализована плавная интерполяция поворота с учётом времени (delta).

### Механизм:

1. **Скорость поворота**: Добавлен параметр `rotationSpeed` (по умолчанию 9.0 радиан/секунду ≈ 515 градусов/секунду)
   - Полный оборот (360°) за ~0.7 секунды
   - Поворот на 90° за ~0.17 секунды
   - Поворот на 20° за ~0.04 секунды (быстро, но не мгновенно)

2. **Кратчайший путь**: Алгоритм автоматически выбирает кратчайший путь поворота
   - Например, поворот с 350° к 10° пройдёт через 0° (20°), а не через 180° (340°)

3. **Зависимость от delta**: Поворот независим от framerate
   - При 60 FPS: ~8.5° за кадр
   - При 30 FPS: ~17° за кадр
   - Плавность одинакова на любом железе

### Алгоритм поворота:

```javascript
// 1. Вычисляем целевой угол
const targetAngle = GeometryUtils.angleToTarget(x, y, target.x, target.y);

// 2. Находим разницу углов
let angleDiff = targetAngle - currentAngle;

// 3. Нормализуем в диапазон [-PI, PI] (кратчайший путь)
while (angleDiff > Math.PI) angleDiff -= Math.PI * 2;
while (angleDiff < -Math.PI) angleDiff += Math.PI * 2;

// 4. Вычисляем максимальный поворот за кадр
const maxRotation = rotationSpeed * (delta / 1000);

// 5. Ограничиваем поворот
const actualRotation = Math.sign(angleDiff) * Math.min(Math.abs(angleDiff), maxRotation);

// 6. Применяем
this.gameObject.setRotation(currentAngle + actualRotation);
```

## Изменения

### `src/systems/strategies/movement/LinearMovementStrategy.js`

1. **Конструктор**: Добавлен параметр `rotationSpeed`
   ```javascript
   this.rotationSpeed = movementConfig.rotationSpeed || 9.0;
   ```

2. **update()**: Передаём `delta` в `moveToTarget()`

3. **moveToTarget()**: Передаём `delta` в `rotateToTarget()`

4. **rotateToTarget()**: Реализована плавная интерполяция вместо мгновенного поворота

## Настройка скорости поворота

Скорость поворота можно настроить для каждого типа врагов через `movement.rotationSpeed`:

```javascript
// В enemyTypes.js
beetle: {
    movement: {
        strategy: 'linear',
        speed: 80,
        rotationSpeed: 12.0  // Быстрее (по умолчанию 9.0)
    }
}
```

**Значения:**
- `rotationSpeed: 6.0` - Медленный поворот (~340°/сек)
- `rotationSpeed: 9.0` - По умолчанию (~515°/сек) ✅
- `rotationSpeed: 12.0` - Быстрый поворот (~690°/сек)
- `rotationSpeed: 15.0` - Очень быстрый (~860°/сек)

## Тестирование

1. Запустить игру
2. Заспавнить врагов (жук, паук, муравей)
3. Разместить камни на пути врагов
4. ✅ Проверить что повороты плавные, не резкие
5. ✅ Проверить что враги всё ещё атакуют корректно
6. ✅ Проверить движение на разных FPS (если возможно)

## Преимущества

1. **Визуально приятнее**: Враги выглядят более естественно
2. **Независимость от FPS**: Работает одинаково на любом железе
3. **Настраиваемость**: Можно задать разную скорость поворота для разных врагов
4. **Кратчайший путь**: Враги не делают лишние обороты

## Дата
18.10.2025

