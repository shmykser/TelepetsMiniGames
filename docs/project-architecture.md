# Архитектура и правила проекта TelepetsMiniGames

## Оглавление
- [Общая архитектура](#общая-архитектура)
- [Структура проекта](#структура-проекта)
- [Паттерны проектирования](#паттерны-проектирования)
- [Системы и их взаимодействие](#системы-и-их-взаимодействие)
- [Правила разработки](#правила-разработки)
- [Конфигурация и настройки](#конфигурация-и-настройки)

## Общая архитектура

Проект построен на основе **модульной архитектуры** с применением **Event-Driven Architecture (EDA)** для декомпозиции игровой логики. Основные принципы:

### Технический стек
- **Frontend**: Phaser 3 (игровой движок)
- **Build Tool**: Vite
- **Package Manager**: npm
- **Telegram Integration**: @twa-dev/sdk
- **Module System**: ES6 modules

### Архитектурные принципы
1. **SOLID** - применение всех принципов SOLID
2. **DRY (Don't Repeat Yourself)** - избегание дублирования кода
3. **Event-Driven Architecture** - система событий для декомпозиции логики
4. **Модульность** - разделение на независимые системы и компоненты
5. **Композиция над наследованием** - использование систем и компонентов

## Структура проекта

### Корневая структура
```
TelepetsMiniGames/
├── config/           # Глобальные настройки (НЕ перемещать в src)
├── src/             # Исходный код приложения
├── public/          # Статические ресурсы
├── docs/            # Документация в формате .md
├── dist/            # Собранное приложение
└── node_modules/    # Зависимости
```

### Структура src/
```
src/
├── components/      # UI компоненты (наследуются от BaseUIComponent)
├── constants/       # Игровые константы и настройки
├── handlers/        # Обработчики событий
├── main.js         # Точка входа приложения
├── objects/        # Игровые объекты (наследуются от GameObject)
├── scenes/         # Сцены Phaser
├── systems/        # Игровые системы
├── telegram/       # Интеграция с Telegram
├── types/          # Типы и конфигурации
└── utils/          # Утилитарные функции
```

## Паттерны проектирования

### 1. Event-Driven Architecture (EDA)
**Центральная система событий** для декомпозиции игровой логики:

```javascript
// EventSystem - центральный диспетчер событий
// EventTypes - константы типов событий  
// EffectHandler - обработчик визуальных эффектов через события
```

**Применение:**
- Декомпозиция игровой логики и визуальных эффектов
- Слабая связанность между компонентами
- Централизованное управление событиями

### 2. Factory Pattern
**Статические методы создания объектов:**

```javascript
Enemy.CreateEnemy(scene, enemyType, x, y, enhancementMultiplier)
Defense.createDefense(scene, defenseType, x, y, enhancementMultiplier)
Egg.CreateEgg(scene, x, y, config)
```

### 3. Observer Pattern
**Реализован через EventSystem:**
- `on()` - подписка на события
- `once()` - одноразовая подписка
- `emit()` - отправка событий
- `off()` - отписка от событий

### 4. Strategy Pattern
**В системах эффектов и жестов:**
- `EffectSystem` - различные стратегии эффектов
- `GestureSystem` - различные стратегии распознавания жестов

### 5. Template Method Pattern
**В базовых классах:**
- `BaseUIComponent` - шаблон для UI компонентов
- `GameObject` - шаблон для игровых объектов

## Системы и их взаимодействие

### Центральные системы

#### EventSystem
- **Назначение**: Центральная система управления событиями
- **Паттерн**: Observer
- **Взаимодействие**: Все системы используют для коммуникации

#### EffectSystem
- **Назначение**: Централизованная система эффектов и анимаций
- **Паттерн**: Strategy + Template Method
- **Методы**: `applyEffect(type, target, intensity, params)`

#### WaveSystem
- **Назначение**: Управление волнами врагов в стиле Vampire Survivors
- **Функции**: Спавн врагов, управление сложностью, временные волны

#### GestureSystem
- **Назначение**: Распознавание жестов (tap, longTap, line, circle, triangle)
- **Технология**: Phaser Input Events + $Q распознаватель

### Вспомогательные системы

#### ProbabilitySystem
- **Назначение**: Централизованная система вероятностей
- **Функции**: Дроп предметов, усиление врагов, случайные события

#### ItemDropSystem
- **Назначение**: Система дропа и обработки предметов
- **Интеграция**: Работает через ProbabilitySystem

#### GestureActionSystem
- **Назначение**: Обработка действий по жестам
- **Функции**: Связывает жесты с игровыми действиями

## Правила разработки

### 1. Иерархия классов

#### Игровые объекты
```
GameObject (базовый класс)
├── Enemy (враги)
├── Defense (защитные сооружения) 
├── Egg (яйцо игрока)
└── Item (предметы)
```

#### UI компоненты
```
BaseUIComponent (базовый класс)
├── Button
├── HealthBar
├── GameTimer
├── DamageIndicator
└── ResultsTable
```

### 2. Создание новых врагов
**ВАЖНО**: НЕ создавать отдельные классы для новых врагов!

```javascript
// ✅ Правильно - определить в enemyTypes.js
export const enemyTypes = {
    newEnemy: {
        name: 'Новый враг',
        health: 50,
        damage: 10,
        // ... другие параметры
    }
};

// ✅ Использовать существующий класс Enemy
const enemy = Enemy.CreateEnemy(scene, 'newEnemy', x, y);
```

### 3. Работа с утилитами
**Вызывать функции GeometryUtils напрямую**, избегать создания обёрток:

```javascript
// ✅ Правильно
const distance = GeometryUtils.distance(x1, y1, x2, y2);

// ❌ Неправильно - не создавать микро-варианты
const distance = this.calculateDistance(x1, y1, x2, y2);
```

### 4. Принцип изменения кода
- **Изменять код только по явному запросу**
- **Изменять только запрошенные части** (если это не сломает код)
- **Предлагать улучшения перед реализацией**
- **НЕ писать "на будущее"** - избегать мёртвого кода

### 5. Конфигурация и настройки

#### Глобальные переменные
- **Игровые настройки и константы** хранить в `./src/settings/GameSettings.js`
- **Настройки проекта (Telegram)** хранить в `./config/settings.js`
- **Новые игровые переменные** добавлять в GameSettings.js

#### Конфиденциальные данные
- **Токены, ключи, пароли** хранить в `.env` файле
- **Файл .env всегда существует**, но доступа к нему нет
- **Записывать в .env**, редактировать вручную

#### Алиасы путей
```javascript
// Настроены в vite.config.js
import { settings } from '@config/settings';
import { GameObject } from '@/objects/GameObject';
```

### 6. Документация
- **Вся документация проекта** в директории `./docs`
- **Формат**: Markdown (.md)
- **Создавать документацию** только по явному запросу

## Конфигурация и настройки

### Основные файлы конфигурации

#### package.json
- **Тип проекта**: ES6 modules (`"type": "module"`)
- **Зависимости**: Phaser 3, Telegram SDK, Vite
- **Скрипты**: dev, build, preview

#### vite.config.js
- **Алиасы**: `@` → src, `@config` → config
- **Сборка**: ES2020, sourcemap включён
- **Сервер**: порт 5173, host: true

#### config/settings.js
- **Настройки проекта** (Telegram интеграция)
- **Не игровые настройки** (вне Phaser)

#### src/settings/GameSettings.js
- **Все игровые настройки** и константы
- **Настройки Phaser**, физика, размеры экрана
- **Игровой процесс**, волны, враги, эффекты
- **Настройки волн**, спавна, сложности
- **UI настройки**, фон, анимации

### Структура настроек

#### config/settings.js (проектные настройки)
```javascript
export const settings = {
    telegram: { /* интеграция с Telegram */ },
    telegramSecrets: { /* токены из .env */ }
};
```

#### src/settings/GameSettings.js (игровые настройки)
```javascript
export const PHASER_SETTINGS = { /* настройки Phaser */ };
export const GAME_SETTINGS = { /* игровой процесс */ };
export const SPAWN_SETTINGS = { /* спавн врагов */ };
export const PHYSICS_CONSTANTS = { /* физика */ };
export const COLORS = { /* цвета */ };
// и другие константы...
```

## Заключение

Данная архитектура обеспечивает:
- **Модульность** и **расширяемость**
- **Слабую связанность** компонентов
- **Переиспользование кода**
- **Централизованное управление** событиями и эффектами
- **Простоту тестирования** и отладки

При разработке новых функций **строго придерживаться** данных принципов и правил.
